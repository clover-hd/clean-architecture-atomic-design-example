<%
/**
 * Header Organism Component
 * @param {Object} [user] - ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
 * @param {number} [cartCount] - ã‚«ãƒ¼ãƒˆå•†å“æ•°
 * @param {string} [currentPath] - ç¾åœ¨ã®ãƒ‘ã‚¹ï¼ˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å¼·èª¿ç”¨ï¼‰
 * @param {string} [class] - è¿½åŠ CSSã‚¯ãƒ©ã‚¹
 */
let userData = null;
let cartItemCount = 0;
let currentUrl = '';
let additionalClass = '';

if (user) userData = user;
if (cartCount) cartItemCount = cartCount;
if (currentPath) currentUrl = currentPath;
if (locals.class) additionalClass = locals.class;
const isLoggedIn = !!userData;

// ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®å®šç¾©
const navigation = [
  { href: '/', text: 'ãƒ›ãƒ¼ãƒ ', active: currentUrl === '/' },
  { href: '/products', text: 'å•†å“ä¸€è¦§', active: currentUrl.startsWith('/products') },
  { href: '/cart', text: 'ã‚«ãƒ¼ãƒˆ', active: currentUrl === '/cart' },
];

const userNavigation = isLoggedIn
  ? [
      { href: '/profile', text: 'ãƒžã‚¤ãƒšãƒ¼ã‚¸', active: currentUrl === '/profile' },
      { href: '/orders', text: 'æ³¨æ–‡å±¥æ­´', active: currentUrl === '/orders' },
      { href: '/auth/logout', text: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ', active: false }
    ]
  : [
      { href: '/auth/login', text: 'ãƒ­ã‚°ã‚¤ãƒ³', active: currentUrl === '/auth/login' },
      { href: '/auth/register', text: 'æ–°è¦ç™»éŒ²', active: currentUrl === '/auth/register' }
    ];
%>

<header class="header <%= additionalClass %>" role="banner">
  <div class="header__container">
    <!-- ãƒ­ã‚´ãƒ»ã‚µã‚¤ãƒˆã‚¿ã‚¤ãƒˆãƒ« -->
    <div class="header__brand">
      <%- include('../atoms/link', {
        href: '/',
        text: 'ECã‚µã‚¤ãƒˆ',
        className: 'header__logo',
        title: 'ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹'
      }) %>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="header__nav" role="navigation" aria-label="ãƒ¡ã‚¤ãƒ³ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
      <ul class="header__nav-list">
        <% navigation.forEach(item => { %>
          <li class="header__nav-item">
            <%- include('../atoms/link', {
              href: item.href,
              text: item.text,
              className: 'header__nav-link' + (item.active ? ' header__nav-link--active' : ''),
              ariaCurrent: item.active ? 'page' : undefined
            }) %>
          </li>
        <% }); %>
      </ul>
    </nav>

    <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="header__search">
      <%- include('../molecules/search-form', {
        className: 'header__search-form',
        placeholder: 'å•†å“æ¤œç´¢...',
        buttonText: 'æ¤œç´¢'
      }) %>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="header__actions">
      <!-- ã‚«ãƒ¼ãƒˆ -->
      <div class="header__cart">
        <a href="/cart" class="header__cart-link" title="ã‚«ãƒ¼ãƒˆã‚’è¦‹ã‚‹">
          <span class="header__cart-icon" aria-hidden="true">ðŸ›’</span>
          <span class="header__cart-text">ã‚«ãƒ¼ãƒˆ</span>
          <% if (cartItemCount > 0) { %>
            <span class="header__cart-count" aria-label="<%= cartItemCount %>å€‹ã®å•†å“">
              <%= cartItemCount %>
            </span>
          <% } %>
        </a>
      </div>

      <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
      <nav class="header__user-nav" role="navigation" aria-label="ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
        <% if (isLoggedIn) { %>
          <div class="header__user-menu">
            <button class="header__user-toggle" aria-expanded="false" aria-haspopup="true">
              <span class="header__user-icon" aria-hidden="true">ðŸ‘¤</span>
              <span class="header__user-name"><%= userData.name %></span>
              <span class="header__user-arrow" aria-hidden="true">â–¼</span>
            </button>
            <ul class="header__user-dropdown" role="menu">
              <% userNavigation.forEach(item => { %>
                <li class="header__user-dropdown-item" role="none">
                  <%- include('../atoms/link', {
                    href: item.href,
                    text: item.text,
                    className: 'header__user-dropdown-link',
                    role: 'menuitem'
                  }) %>
                </li>
              <% }); %>
            </ul>
          </div>
        <% } else { %>
          <ul class="header__auth-links">
            <% userNavigation.forEach(item => { %>
              <li class="header__auth-item">
                <%- include('../atoms/link', {
                  href: item.href,
                  text: item.text,
                  className: 'header__auth-link' + (item.active ? ' header__auth-link--active' : '')
                }) %>
              </li>
            <% }); %>
          </ul>
        <% } %>
      </nav>
    </div>

    <!-- ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ -->
    <button class="header__mobile-toggle" aria-expanded="false" aria-controls="mobile-menu">
      <span class="header__mobile-toggle-bar"></span>
      <span class="header__mobile-toggle-bar"></span>
      <span class="header__mobile-toggle-bar"></span>
      <span class="header__mobile-toggle-text">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span>
    </button>
  </div>

  <!-- ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <div class="header__mobile-menu" id="mobile-menu" aria-hidden="true">
    <nav class="header__mobile-nav" role="navigation" aria-label="ãƒ¢ãƒã‚¤ãƒ«ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
      <ul class="header__mobile-nav-list">
        <% navigation.forEach(item => { %>
          <li class="header__mobile-nav-item">
            <%- include('../atoms/link', {
              href: item.href,
              text: item.text,
              className: 'header__mobile-nav-link' + (item.active ? ' header__mobile-nav-link--active' : '')
            }) %>
          </li>
        <% }); %>

        <% userNavigation.forEach(item => { %>
          <li class="header__mobile-nav-item">
            <%- include('../atoms/link', {
              href: item.href,
              text: item.text,
              className: 'header__mobile-nav-link'
            }) %>
          </li>
        <% }); %>
      </ul>
    </nav>
  </div>
</header>