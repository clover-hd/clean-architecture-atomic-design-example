<%
/**
 * Cart Page
 * @param {Object} cart - ã‚«ãƒ¼ãƒˆæƒ…å ±
 * @param {Object} [user] - ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
 */
const cartData = cart || {};
const userData = user || null;

// ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ
const breadcrumbs = [
  { href: '/', text: 'ãƒ›ãƒ¼ãƒ ' },
  { href: '/cart', text: 'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆ' }
];

const isEmpty = !cartData.items || cartData.items.length === 0;
%>

<% layout('./templates/base', {
  title: 'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆ',
  description: 'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆã®å†…å®¹ã‚’ç¢ºèªã—ã€ãŠä¼šè¨ˆã«ãŠé€²ã¿ãã ã•ã„ã€‚',
  breadcrumbs: breadcrumbs,
  bodyClass: 'page-cart',
  customScripts: ['/js/cart.js']
}) %>

<div class="cart-page">
  <div class="cart-page__container">
    <!-- Page Header -->
    <header class="cart-page__header">
      <h1 class="cart-page__title">ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆ</h1>
      <% if (!isEmpty) { %>
        <p class="cart-page__item-count">
          <%= cartData.items.length %>ç¨®é¡ã®å•†å“
        </p>
      <% } %>
    </header>

    <% if (isEmpty) { %>
      <!-- Empty Cart -->
      <div class="cart-page__empty">
        <div class="cart-page__empty-content">
          <div class="cart-page__empty-icon">ğŸ›’</div>
          <h2 class="cart-page__empty-title">ã‚«ãƒ¼ãƒˆã¯ç©ºã§ã™</h2>
          <p class="cart-page__empty-description">
            å•†å“ã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¦ã€ãŠè²·ã„ç‰©ã‚’ãŠæ¥½ã—ã¿ãã ã•ã„ã€‚
          </p>
          <div class="cart-page__empty-actions">
            <%- include('../atoms/button', {
              type: 'primary',
              text: 'å•†å“ã‚’è¦‹ã‚‹',
              href: '/products',
              size: 'large',
              className: 'cart-page__shop-button'
            }) %>
          </div>
        </div>
      </div>
    <% } else { %>
      <!-- Cart Content -->
      <div class="cart-page__content">
        <!-- Cart Items -->
        <div class="cart-page__items">
          <%- include('../organisms/cart-table', {
            cart: cartData,
            editable: true,
            className: 'cart-page__table'
          }) %>
        </div>

        <!-- Cart Summary -->
        <div class="cart-page__summary">
          <%- include('../molecules/cart-summary', {
            cart: cartData,
            showCheckout: true,
            className: 'cart-page__summary-widget'
          }) %>

          <!-- Promo Code -->
          <div class="cart-page__promo">
            <h3 class="cart-page__promo-title">ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰</h3>
            <form class="cart-page__promo-form" action="/cart/promo" method="POST">
              <div class="cart-page__promo-input-group">
                <%- include('../atoms/input', {
                  type: 'text',
                  name: 'promoCode',
                  placeholder: 'ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›',
                  className: 'cart-page__promo-input'
                }) %>

                <%- include('../atoms/button', {
                  type: 'secondary',
                  text: 'é©ç”¨',
                  className: 'cart-page__promo-button'
                }) %>
              </div>
            </form>
          </div>

          <!-- Security Badges -->
          <div class="cart-page__security">
            <h4 class="cart-page__security-title">å®‰å¿ƒãƒ»å®‰å…¨ãªãŠè²·ã„ç‰©</h4>
            <div class="cart-page__security-badges">
              <div class="cart-page__security-badge">
                <span class="cart-page__security-icon">ğŸ”’</span>
                <span class="cart-page__security-text">SSLæš—å·åŒ–</span>
              </div>
              <div class="cart-page__security-badge">
                <span class="cart-page__security-icon">ğŸ›¡ï¸</span>
                <span class="cart-page__security-text">å€‹äººæƒ…å ±ä¿è­·</span>
              </div>
              <div class="cart-page__security-badge">
                <span class="cart-page__security-icon">ğŸ“</span>
                <span class="cart-page__security-text">ã‚µãƒãƒ¼ãƒˆå¯¾å¿œ</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recommended Products -->
      <section class="cart-page__recommendations">
        <div class="cart-page__recommendations-header">
          <h2 class="cart-page__recommendations-title">ã“ã¡ã‚‰ã‚‚ã„ã‹ãŒã§ã™ã‹ï¼Ÿ</h2>
          <p class="cart-page__recommendations-description">
            ã‚«ãƒ¼ãƒˆã®å•†å“ã¨ä¸€ç·’ã«ã‚ˆãè³¼å…¥ã•ã‚Œã‚‹å•†å“
          </p>
        </div>

        <div class="cart-page__recommendations-grid" id="recommended-products">
          <!-- Recommended products will be loaded here via JavaScript -->
        </div>
      </section>

      <!-- Cart Actions Footer -->
      <div class="cart-page__actions">
        <div class="cart-page__actions-container">
          <div class="cart-page__continue-shopping">
            <%- include('../atoms/link', {
              href: '/products',
              text: 'â† è²·ã„ç‰©ã‚’ç¶šã‘ã‚‹',
              className: 'cart-page__continue-link'
            }) %>
          </div>

          <div class="cart-page__checkout-actions">
            <% if (!userData) { %>
              <p class="cart-page__login-prompt">
                <%- include('../atoms/link', {
                  href: '/auth/login?redirect=/cart',
                  text: 'ãƒ­ã‚°ã‚¤ãƒ³',
                  className: 'cart-page__login-link'
                }) %>
                ã—ã¦ã‚¹ãƒ ãƒ¼ã‚ºã«ãŠä¼šè¨ˆ
              </p>
            <% } %>

            <%- include('../atoms/button', {
              type: 'primary',
              text: 'ãƒ¬ã‚¸ã«é€²ã‚€',
              href: '/checkout',
              size: 'large',
              className: 'cart-page__checkout-button'
            }) %>
          </div>
        </div>
      </div>
    <% } %>

    <!-- Help Information -->
    <aside class="cart-page__help">
      <h3 class="cart-page__help-title">ãŠå›°ã‚Šã§ã™ã‹ï¼Ÿ</h3>
      <ul class="cart-page__help-list">
        <li class="cart-page__help-item">
          <%- include('../atoms/link', {
            href: '/help/shipping',
            text: 'é…é€ã«ã¤ã„ã¦',
            className: 'cart-page__help-link'
          }) %>
        </li>
        <li class="cart-page__help-item">
          <%- include('../atoms/link', {
            href: '/help/returns',
            text: 'è¿”å“ãƒ»äº¤æ›ã«ã¤ã„ã¦',
            className: 'cart-page__help-link'
          }) %>
        </li>
        <li class="cart-page__help-item">
          <%- include('../atoms/link', {
            href: '/help/payment',
            text: 'ãŠæ”¯æ‰•ã„æ–¹æ³•ã«ã¤ã„ã¦',
            className: 'cart-page__help-link'
          }) %>
        </li>
        <li class="cart-page__help-item">
          <%- include('../atoms/link', {
            href: '/contact',
            text: 'ãŠå•ã„åˆã‚ã›',
            className: 'cart-page__help-link'
          }) %>
        </li>
      </ul>
    </aside>
  </div>
</div>

<!-- Page-specific script -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Load recommended products
    if (!<%= isEmpty %>) {
      loadRecommendedProducts();
    }

    // Cart update animations
    const cartTable = document.querySelector('.cart-page__table');
    if (cartTable) {
      cartTable.addEventListener('cartUpdated', function(event) {
        // Animate cart updates
        const updatedRow = event.target.closest('.cart-table__row');
        if (updatedRow) {
          updatedRow.classList.add('cart-table__row--updated');
          setTimeout(() => {
            updatedRow.classList.remove('cart-table__row--updated');
          }, 1000);
        }
      });
    }
  });

  // Load recommended products
  function loadRecommendedProducts() {
    const container = document.getElementById('recommended-products');
    if (!container) return;

    // Show loading state
    container.innerHTML = '<div class="cart-page__recommendations-loading">èª­ã¿è¾¼ã¿ä¸­...</div>';

    // Fetch recommended products
    fetch('/api/cart/recommendations')
      .then(response => response.json())
      .then(data => {
        if (data.products && data.products.length > 0) {
          renderRecommendedProducts(data.products, container);
        } else {
          container.style.display = 'none';
        }
      })
      .catch(error => {
        console.error('Failed to load recommendations:', error);
        container.style.display = 'none';
      });
  }

  // Render recommended products
  function renderRecommendedProducts(products, container) {
    container.innerHTML = products.slice(0, 4).map(product => `
      <div class="cart-page__recommendation-item">
        <a href="/products/${product.id}" class="cart-page__recommendation-link">
          <img src="${product.image || '/images/no-image.jpg'}"
               alt="${product.name}"
               class="cart-page__recommendation-image">
          <h4 class="cart-page__recommendation-name">${product.name}</h4>
          <p class="cart-page__recommendation-price">Â¥${product.price.toLocaleString()}</p>
        </a>
        <button class="cart-page__recommendation-add"
                onclick="addToCart('${product.id}', 1)"
                ${product.stock <= 0 ? 'disabled' : ''}>
          ${product.stock <= 0 ? 'åœ¨åº«åˆ‡ã‚Œ' : 'ã‚«ãƒ¼ãƒˆã«è¿½åŠ '}
        </button>
      </div>
    `).join('');
  }
</script>