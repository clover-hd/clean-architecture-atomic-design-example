<%
/**
 * Checkout Page
 * @param {Object} cart - ã‚«ãƒ¼ãƒˆæƒ…å ±
 * @param {Object} [user] - ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
 * @param {Object} [errors] - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
 * @param {Object} [formData] - ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿
 */
const cartData = cart || {};
const userData = user || null;
const formErrors = errors || {};
const formValues = formData || {};

// ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ
const breadcrumbs = [
  { href: '/', text: 'ãƒ›ãƒ¼ãƒ ' },
  { href: '/cart', text: 'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆ' },
  { href: '/checkout', text: 'ã”æ³¨æ–‡æ‰‹ç¶šã' }
];

const isEmpty = !cartData.items || cartData.items.length === 0;
%>

<% layout('./templates/base', {
  title: 'ã”æ³¨æ–‡æ‰‹ç¶šã',
  description: 'ã”æ³¨æ–‡ã®æœ€çµ‚ç¢ºèªã¨ãŠå®¢æ§˜æƒ…å ±ã®å…¥åŠ›ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚',
  breadcrumbs: breadcrumbs,
  bodyClass: 'page-checkout',
  customScripts: ['/js/checkout.js']
}) %>

<% if (isEmpty) { %>
  <!-- Empty Cart Redirect -->
  <div class="checkout-page__empty">
    <div class="checkout-page__empty-container">
      <h1 class="checkout-page__empty-title">ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™</h1>
      <p class="checkout-page__empty-description">
        ã”æ³¨æ–‡æ‰‹ç¶šãã‚’è¡Œã†ã«ã¯ã€ã¾ãšå•†å“ã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
      </p>
      <%- include('../atoms/button', {
        type: 'primary',
        text: 'å•†å“ã‚’è¦‹ã‚‹',
        href: '/products',
        size: 'large'
      }) %>
    </div>
  </div>
<% } else { %>
  <div class="checkout-page">
    <div class="checkout-page__container">
      <!-- Page Header -->
      <header class="checkout-page__header">
        <h1 class="checkout-page__title">ã”æ³¨æ–‡æ‰‹ç¶šã</h1>

        <!-- Checkout Steps -->
        <nav class="checkout-steps" aria-label="æ³¨æ–‡æ‰‹ç¶šãã®ã‚¹ãƒ†ãƒƒãƒ—">
          <ol class="checkout-steps__list">
            <li class="checkout-steps__item checkout-steps__item--active">
              <span class="checkout-steps__number">1</span>
              <span class="checkout-steps__label">ãŠå®¢æ§˜æƒ…å ±</span>
            </li>
            <li class="checkout-steps__item">
              <span class="checkout-steps__number">2</span>
              <span class="checkout-steps__label">ãŠæ”¯æ‰•ã„</span>
            </li>
            <li class="checkout-steps__item">
              <span class="checkout-steps__number">3</span>
              <span class="checkout-steps__label">å®Œäº†</span>
            </li>
          </ol>
        </nav>
      </header>

      <div class="checkout-page__content">
        <!-- Order Form -->
        <div class="checkout-page__form">
          <%- include('../organisms/order-form', {
            user: userData,
            cart: cartData,
            errors: formErrors,
            formData: formValues,
            className: 'checkout-page__order-form'
          }) %>
        </div>

        <!-- Order Summary -->
        <div class="checkout-page__summary">
          <!-- Cart Summary -->
          <%- include('../molecules/cart-summary', {
            cart: cartData,
            showCheckout: false,
            className: 'checkout-page__cart-summary'
          }) %>

          <!-- Order Items -->
          <div class="checkout-page__items">
            <h3 class="checkout-page__items-title">ã”æ³¨æ–‡å†…å®¹</h3>
            <div class="checkout-page__items-list">
              <% cartData.items.forEach(item => { %>
                <div class="checkout-page__item">
                  <div class="checkout-page__item-image">
                    <%- include('../atoms/image', {
                      src: item.product.image || '/images/no-image.jpg',
                      alt: item.product.name,
                      className: 'checkout-page__item-img',
                      width: '60',
                      height: '60'
                    }) %>
                  </div>

                  <div class="checkout-page__item-details">
                    <h4 class="checkout-page__item-name">
                      <%= item.product.name %>
                    </h4>
                    <div class="checkout-page__item-meta">
                      <span class="checkout-page__item-quantity">
                        æ•°é‡: <%= item.quantity %>
                      </span>
                      <span class="checkout-page__item-price">
                        Â¥<%= item.product.price.toLocaleString() %>
                      </span>
                    </div>
                  </div>

                  <div class="checkout-page__item-total">
                    Â¥<%= (item.product.price * item.quantity).toLocaleString() %>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>

          <!-- Security Information -->
          <div class="checkout-page__security">
            <h4 class="checkout-page__security-title">å®‰å¿ƒãƒ»å®‰å…¨ãªãŠå–å¼•</h4>
            <ul class="checkout-page__security-list">
              <li class="checkout-page__security-item">
                <span class="checkout-page__security-icon">ğŸ”’</span>
                SSLæš—å·åŒ–é€šä¿¡ã§å€‹äººæƒ…å ±ã‚’ä¿è­·
              </li>
              <li class="checkout-page__security-item">
                <span class="checkout-page__security-icon">ğŸ›¡ï¸</span>
                å³é‡ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç®¡ç†
              </li>
              <li class="checkout-page__security-item">
                <span class="checkout-page__security-icon">ğŸ“</span>
                è³¼å…¥å¾Œã®ã‚µãƒãƒ¼ãƒˆå¯¾å¿œ
              </li>
            </ul>
          </div>

          <!-- Return Policy -->
          <div class="checkout-page__policy">
            <h4 class="checkout-page__policy-title">è¿”å“ãƒ»äº¤æ›ã«ã¤ã„ã¦</h4>
            <p class="checkout-page__policy-text">
              å•†å“åˆ°ç€å¾Œ14æ—¥ä»¥å†…ã§ã‚ã‚Œã°ã€æœªä½¿ç”¨ãƒ»æœªé–‹å°ã®å•†å“ã«é™ã‚Šè¿”å“ãƒ»äº¤æ›ã‚’æ‰¿ã‚Šã¾ã™ã€‚
            </p>
            <p class="checkout-page__policy-link">
              <%- include('../atoms/link', {
                href: '/help/returns',
                text: 'è©³ç´°ã¯ã“ã¡ã‚‰',
                className: 'checkout-page__policy-link-text'
              }) %>
            </p>
          </div>
        </div>
      </div>

      <!-- Back to Cart -->
      <div class="checkout-page__back">
        <%- include('../atoms/link', {
          href: '/cart',
          text: 'â† ã‚«ãƒ¼ãƒˆã«æˆ»ã‚‹',
          className: 'checkout-page__back-link'
        }) %>
      </div>
    </div>
  </div>
<% } %>

<!-- Page-specific script -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Form validation
    const orderForm = document.querySelector('.order-form__form');
    if (orderForm) {
      orderForm.addEventListener('submit', function(event) {
        if (!validateOrderForm(this)) {
          event.preventDefault();
          scrollToFirstError();
        } else {
          // Show loading state
          showCheckoutLoading();
        }
      });
    }

    // Auto-fill user data if logged in
    <% if (userData) { %>
      autoFillUserData({
        email: '<%= userData.email || "" %>',
        lastName: '<%= userData.lastName || "" %>',
        firstName: '<%= userData.firstName || "" %>',
        phone: '<%= userData.phone || "" %>',
        postalCode: '<%= userData.postalCode || "" %>',
        prefecture: '<%= userData.prefecture || "" %>',
        city: '<%= userData.city || "" %>',
        address: '<%= userData.address || "" %>'
      });
    <% } %>

    // Address lookup by postal code
    const postalCodeInput = document.getElementById('postalCode');
    if (postalCodeInput) {
      postalCodeInput.addEventListener('change', function() {
        lookupAddress(this.value);
      });
    }

    // Payment method change handler
    const paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
    paymentMethods.forEach(method => {
      method.addEventListener('change', function() {
        updatePaymentInfo(this.value);
      });
    });

    // Shipping option change handler
    const shippingOptions = document.querySelectorAll('input[name="shippingOption"]');
    shippingOptions.forEach(option => {
      option.addEventListener('change', function() {
        updateShippingCost(this.value);
      });
    });
  });

  // Validate order form
  function validateOrderForm(form) {
    const requiredFields = form.querySelectorAll('[required]');
    let isValid = true;

    requiredFields.forEach(field => {
      if (!field.value.trim()) {
        markFieldError(field, 'å¿…é ˆé …ç›®ã§ã™');
        isValid = false;
      } else {
        clearFieldError(field);
      }
    });

    // Email validation
    const emailField = form.querySelector('input[type="email"]');
    if (emailField && emailField.value) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(emailField.value)) {
        markFieldError(emailField, 'æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        isValid = false;
      }
    }

    // Phone validation
    const phoneField = form.querySelector('input[type="tel"]');
    if (phoneField && phoneField.value) {
      const phoneRegex = /^[0-9-+().\s]+$/;
      if (!phoneRegex.test(phoneField.value)) {
        markFieldError(phoneField, 'æ­£ã—ã„é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        isValid = false;
      }
    }

    // Terms agreement
    const termsCheckbox = form.querySelector('input[name="agreeToTerms"]');
    if (termsCheckbox && !termsCheckbox.checked) {
      markFieldError(termsCheckbox, 'åˆ©ç”¨è¦ç´„ã¸ã®åŒæ„ãŒå¿…è¦ã§ã™');
      isValid = false;
    }

    return isValid;
  }

  // Show checkout loading state
  function showCheckoutLoading() {
    const submitButton = document.querySelector('.order-form__submit');
    if (submitButton) {
      submitButton.disabled = true;
      submitButton.textContent = 'å‡¦ç†ä¸­...';
    }

    // Show loading overlay
    const loadingOverlay = document.getElementById('loading-overlay');
    if (loadingOverlay) {
      loadingOverlay.style.display = 'flex';
    }
  }

  // Address lookup by postal code (mock implementation)
  function lookupAddress(postalCode) {
    if (!postalCode.match(/^\d{3}-\d{4}$/)) return;

    // Mock address lookup - in real implementation, you'd call an API
    const mockAddresses = {
      '100-0001': { prefecture: 'æ±äº¬éƒ½', city: 'åƒä»£ç”°åŒº' },
      '150-0001': { prefecture: 'æ±äº¬éƒ½', city: 'æ¸‹è°·åŒº' },
      '530-0001': { prefecture: 'å¤§é˜ªåºœ', city: 'å¤§é˜ªå¸‚åŒ—åŒº' }
    };

    const address = mockAddresses[postalCode];
    if (address) {
      const prefectureSelect = document.getElementById('prefecture');
      const cityInput = document.getElementById('city');

      if (prefectureSelect) prefectureSelect.value = address.prefecture;
      if (cityInput) cityInput.value = address.city;
    }
  }
</script>
<% } %>